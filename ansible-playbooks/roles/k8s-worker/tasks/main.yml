---

- name: Check if node is already part of cluster
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Join cluster tasks
  when: not kubelet_conf.stat.exists
  block:
    - name: Get join command from control plane
      ansible.builtin.command:
        cmd: kubeadm token create --print-join-command
      register: join_command
      delegate_to: "{{ groups['controlplane'][0] }}"
      run_once: true
      changed_when: false

    - name: Parse join command to extract server URL
      ansible.builtin.set_fact:
        join_base_command: "{{ join_command.stdout }}"

    - name: Display join command
      ansible.builtin.debug:
        msg: "{{ join_base_command }}"

    - name: Join worker to cluster with specific node IP
      ansible.builtin.command:
        cmd: "{{ join_base_command }}"
      become: true
      register: join_result

    - name: Display join result
      ansible.builtin.debug:
        var: join_result.stdout_lines

- name: Node already joined message
  ansible.builtin.debug:
    msg: "Node is already part of the cluster"
  when: kubelet_conf.stat.exists

- name: Create .kube directory on worker
  ansible.builtin.file:
    path: "{{ ansible_facts['user_dir'] }}/.kube"
    state: directory
    mode: '0755'

- name: Copy kubeconfig from control plane to worker
  ansible.builtin.slurp:
    src: "{{ hostvars[groups['controlplane'][0]].ansible_facts['user_dir'] }}/.kube/config"
  delegate_to: "{{ groups['controlplane'][0] }}"
  register: kubeconfig_content
  run_once: true

- name: Write kubeconfig on worker
  ansible.builtin.copy:
    content: "{{ kubeconfig_content.content | b64decode }}"
    dest: "{{ ansible_facts['user_dir'] }}/.kube/config"
    mode: '0600'

- name: Verify kubectl access from worker
  ansible.builtin.command:
    cmd: kubectl get nodes
  environment:
    KUBECONFIG: "{{ ansible_facts['user_dir'] }}/.kube/config"
  register: kubectl_test
  changed_when: false

- name: Display kubectl test result
  ansible.builtin.debug:
    var: kubectl_test.stdout_lines

- name: Wait for kubelet to be active
  ansible.builtin.systemd:
    name: kubelet
    state: started
    enabled: true
  become: true

- name: Verify node joined successfully
  ansible.builtin.command:
    cmd: kubectl get nodes {{ ansible_facts['nodename'] }} -o wide
  environment:
    KUBECONFIG: "{{ hostvars[groups['controlplane'][0]].ansible_facts['user_dir'] }}/.kube/config"
  delegate_to: "{{ groups['controlplane'][0] }}"
  register: node_status
